<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPA Network Security Auditor</title>
    <style>
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #7209b7;
            --dark: #3a0ca3;
            --light: #f8f9fa;
            --gray: #6c757d;
            --border-radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.97);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            padding: 30px;
            max-width: 1000px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .header h1 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .header p {
            color: var(--gray);
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .security-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        .risk-score {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .score-value {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 15px 0;
            background: linear-gradient(135deg, var(--success), var(--primary), var(--warning), var(--danger));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .score-label {
            font-size: 1.1rem;
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .risk-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }
        
        .risk-fill {
            height: 100%;
            background: linear-gradient(to right, var(--success), var(--warning), var(--danger));
            width: 0%;
            transition: width 1.5s ease-in-out;
        }
        
        .risk-marker {
            position: absolute;
            top: -4px;
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid var(--dark);
            border-radius: 50%;
            transform: translateX(-50%);
            transition: left 1.5s ease-in-out;
        }
        
        .risk-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .status-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .status-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .status-card.warning {
            border-left-color: var(--warning);
        }
        
        .status-card.danger {
            border-left-color: var(--danger);
        }
        
        .status-card.success {
            border-left-color: var(--success);
        }
        
        .status-title {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .details-panel {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }
        
        .panel-title {
            font-size: 1.3rem;
            color: var(--dark);
            font-weight: 600;
        }
        
        .toggle-icon {
            font-size: 1.5rem;
            color: var(--primary);
            transition: transform 0.3s ease;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .panel-content {
            display: none;
        }
        
        .panel-content.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .check-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .check-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #dee2e6;
        }
        
        .check-item.safe {
            border-left-color: var(--success);
            background: rgba(76, 201, 240, 0.05);
        }
        
        .check-item.risk {
            border-left-color: var(--warning);
            background: rgba(247, 37, 133, 0.05);
        }
        
        .check-item.danger {
            border-left-color: var(--danger);
            background: rgba(114, 9, 183, 0.05);
        }
        
        .check-name {
            color: var(--dark);
            font-weight: 500;
        }
        
        .check-status {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .check-status.safe {
            color: var(--success);
        }
        
        .check-status.risk {
            color: var(--warning);
        }
        
        .check-status.danger {
            color: var(--danger);
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--success), var(--primary));
            width: 0%;
            transition: width 0.8s ease-in-out;
        }
        
        .final-result {
            text-align: center;
            padding: 30px;
            border-radius: var(--border-radius);
            margin-top: 25px;
            display: none;
        }
        
        .result-safe {
            background: rgba(76, 201, 240, 0.1);
            border: 2px solid var(--success);
            display: block;
        }
        
        .result-warning {
            background: rgba(247, 37, 133, 0.1);
            border: 2px solid var(--warning);
            display: block;
        }
        
        .result-danger {
            background: rgba(114, 9, 183, 0.1);
            border: 2px solid var(--danger);
            display: block;
        }
        
        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .result-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .result-desc {
            color: var(--gray);
            margin-bottom: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .tracking-data {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 25px;
            font-family: monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            white-space: pre-wrap;
            display: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: #e9ecef;
            color: var(--gray);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .timestamp {
            font-size: 0.8rem;
            color: var(--gray);
            text-align: center;
            margin-top: 15px;
        }
        
        .device-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .device-tag {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="security-icon">🛡️</div>
            <h1>CPA Network Security Auditor</h1>
            <p>Advanced fraud detection & traffic quality analysis at network level</p>
        </div>
        
        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <p>Running comprehensive security audit...</p>
            <div class="progress-container">
                <div class="progress-label">
                    <span>Verification Progress</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <div class="timestamp" id="loadingTimestamp"></div>
        </div>
        
        <div id="resultsSection" style="display: none;">
            <div class="dashboard">
                <div class="risk-score">
                    <div class="score-label">FRAUD RISK SCORE</div>
                    <div class="score-value" id="riskScoreValue">0</div>
                    <div class="risk-bar">
                        <div class="risk-fill" id="riskFill"></div>
                        <div class="risk-marker" id="riskMarker"></div>
                    </div>
                    <div class="risk-labels">
                        <span>Low Risk</span>
                        <span>Medium Risk</span>
                        <span>High Risk</span>
                    </div>
                    <div class="score-label" id="riskCategory">Calculating...</div>
                </div>
                
                <div class="status-cards">
                    <div class="status-card" id="ipCard">
                        <div class="status-title">🌐 IP Reputation</div>
                        <div class="status-value" id="ipStatus">Checking...</div>
                    </div>
                    <div class="status-card" id="deviceCard">
                        <div class="status-title">📱 Device Fingerprint</div>
                        <div class="status-value" id="deviceStatus">Checking...</div>
                    </div>
                    <div class="status-card" id="behaviorCard">
                        <div class="status-title">⚡ Behavior Analysis</div>
                        <div class="status-value" id="behaviorStatus">Checking...</div>
                    </div>
                    <div class="status-card" id="geoCard">
                        <div class="status-title">📍 Geographic Analysis</div>
                        <div class="status-value" id="geoStatus">Checking...</div>
                    </div>
                </div>
            </div>
            
            <div class="details-panel">
                <div class="panel-header" id="toggleDetails">
                    <div class="panel-title">Detailed Security Report</div>
                    <div class="toggle-icon">▼</div>
                </div>
                <div class="panel-content" id="detailsContent">
                    <div class="check-grid">
                        <div class="check-item" id="checkIp">
                            <span class="check-name">IP Address & ISP Analysis</span>
                            <span class="check-status">Pending</span>
                        </div>
                        <div class="check-item" id="checkVpn">
                            <span class="check-name">VPN/Proxy Detection</span>
                            <span class="check-status">Pending</span>
                        </div>
                        <div class="check-item" id="checkDataCenter">
                            <span class="check-name">Data Center IP Check</span>
                            <span class="check-status">Pending</span>
                        </div>
                        <div class="check-item" id="checkDevice">
                            <span class="check-name">Device Consistency</span>
                            <span class="check-status">Pending</span>
                        </div>
                        <div class="check-item" id="checkBrowser">
                            <span class="check-name">Browser Validation</span>
                            <span class="check-status">Pending</span>
                        </div>
                        <div class="check-item" id="checkBehavior">
                            <span class="check-name">User Behavior Patterns</span>
                            <span class="check-status">Pending</span>
                        </div>
                        <div class="check-item" id="checkGeo">
                            <span class="check-name">Geolocation Consistency</span>
                            <span class="check-status">Pending</span>
                        </div>
                        <div class="check-item" id="clickPattern">
                            <span class="check-name">Click Pattern Analysis</span>
                            <span class="check-status">Pending</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="final-result" id="finalResult">
                <div class="result-icon" id="resultIcon">🛡️</div>
                <div class="result-title" id="resultTitle">Security Analysis Complete</div>
                <div class="result-desc" id="resultDesc">Your connection has been verified</div>
                
                <div class="device-info" id="deviceInfo">
                    <!-- Device info will be populated here -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="window.location.reload()">
                        <span>🔄</span> Re-test Connection
                    </button>
                    <button class="btn btn-primary" onclick="toggleTrackingData()">
                        <span>📊</span> View Tracking Data
                    </button>
                </div>
            </div>
            
            <div class="tracking-data" id="trackingData">
                <!-- Tracking data will be populated here -->
            </div>
            
            <div class="timestamp" id="resultTimestamp"></div>
        </div>
    </div>

    <script>
        // Enhanced CPA network-level fraud detection
        const fraudResults = {
            // Basic info
            ip: null,
            country: null,
            countryName: null,
            region: null,
            city: null,
            isp: null,
            asn: null,
            organization: null,
            
            // Risk flags
            isVPN: false,
            isProxy: false,
            isHosting: false,
            isTor: false,
            isBot: false,
            
            // Device info
            deviceType: null,
            deviceBrand: null,
            deviceOS: null,
            browser: null,
            screenResolution: null,
            timezone: null,
            language: null,
            
            // Behavioral data
            mouseMovements: 0,
            clickCount: 0,
            scrollEvents: 0,
            keyPresses: 0,
            pageLoadTime: null,
            timeOnPage: null,
            
            // Risk scoring
            riskScore: 0,
            warnings: [],
            checks: {},
            
            // CPA tracking data
            clickId: generateClickId(),
            sessionId: generateSessionId(),
            timestamp: new Date().toISOString(),
            referrer: document.referrer || 'Direct'
        };

        // Generate unique IDs for tracking
        function generateClickId() {
            return 'CLK_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function generateSessionId() {
            return 'SES_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // Update progress bar
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
        }

        // Update timestamp
        function updateTimestamp(elementId) {
            const now = new Date();
            document.getElementById(elementId).textContent = 
                'Last updated: ' + now.toLocaleTimeString() + ' • ' + now.toLocaleDateString();
        }

        // Update check status in UI
        function updateCheckStatus(checkId, status, text) {
            const element = document.getElementById(checkId);
            const statusElement = element.querySelector('.check-status');
            
            statusElement.textContent = text;
            statusElement.className = 'check-status ' + status;
            element.className = 'check-item ' + status;
        }

        // Update status card
        function updateStatusCard(cardId, status, text) {
            const card = document.getElementById(cardId);
            const valueElement = card.querySelector('.status-value');
            
            valueElement.textContent = text;
            card.className = 'status-card ' + status;
        }

        // Simulate progress for better UX
        function simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 5;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                updateProgress(progress);
            }, 200);
            
            // Update timestamp every 5 seconds
            setInterval(() => updateTimestamp('loadingTimestamp'), 5000);
            updateTimestamp('loadingTimestamp');
        }

        // Advanced device detection (FIXED for Android)
        function detectDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            let deviceType = 'Desktop';
            let deviceBrand = 'Unknown';
            let deviceOS = 'Unknown';
            let browser = 'Unknown';
            
            // Device type detection
            if (/mobile|android|iphone|ipod|ipad|blackberry|iemobile|opera mini/i.test(userAgent)) {
                deviceType = 'Mobile';
            } else if (/tablet|ipad|playbook|silk/i.test(userAgent)) {
                deviceType = 'Tablet';
            }
            
            // OS detection
            if (/android/.test(userAgent)) {
                deviceOS = 'Android';
                // Extract Android version if available
                const androidVersion = userAgent.match(/android\s([0-9\.]+)/);
                if (androidVersion) deviceOS += ' ' + androidVersion[1];
            } else if (/ios|iphone|ipad|ipod/.test(userAgent)) {
                deviceOS = 'iOS';
                const iosVersion = userAgent.match(/os\s([0-9_]+)/);
                if (iosVersion) deviceOS += ' ' + iosVersion[1].replace(/_/g, '.');
            } else if (/windows/.test(userAgent)) {
                deviceOS = 'Windows';
            } else if (/mac os/.test(userAgent)) {
                deviceOS = 'macOS';
            } else if (/linux/.test(userAgent)) {
                deviceOS = 'Linux';
            }
            
            // Browser detection
            if (/chrome/.test(userAgent) && !/edg/.test(userAgent)) {
                browser = 'Chrome';
                const chromeVersion = userAgent.match(/chrome\/([0-9\.]+)/);
                if (chromeVersion) browser += ' ' + chromeVersion[1].split('.')[0];
            } else if (/firefox/.test(userAgent)) {
                browser = 'Firefox';
            } else if (/safari/.test(userAgent) && !/chrome/.test(userAgent)) {
                browser = 'Safari';
            } else if (/edg/.test(userAgent)) {
                browser = 'Edge';
            } else if (/opera|opr/.test(userAgent)) {
                browser = 'Opera';
            }
            
            // Device brand detection (for mobile)
            if (/samsung/.test(userAgent)) deviceBrand = 'Samsung';
            else if (/xiaomi|redmi|poco/.test(userAgent)) deviceBrand = 'Xiaomi';
            else if (/iphone|ipad|ipod/.test(userAgent)) deviceBrand = 'Apple';
            else if (/huawei|honor/.test(userAgent)) deviceBrand = 'Huawei';
            else if (/oppo/.test(userAgent)) deviceBrand = 'Oppo';
            else if (/vivo/.test(userAgent)) deviceBrand = 'Vivo';
            else if (/realme/.test(userAgent)) deviceBrand = 'Realme';
            else if (/oneplus/.test(userAgent)) deviceBrand = 'OnePlus';
            else if (/nokia/.test(userAgent)) deviceBrand = 'Nokia';
            else if (/sony/.test(userAgent)) deviceBrand = 'Sony';
            else if (/lg/.test(userAgent)) deviceBrand = 'LG';
            else if (/motorola|moto/.test(userAgent)) deviceBrand = 'Motorola';
            else if (/htc/.test(userAgent)) deviceBrand = 'HTC';
            else if (/google/.test(userAgent)) deviceBrand = 'Google';
            else if (/asus/.test(userAgent)) deviceBrand = 'ASUS';
            else if (/lenovo/.test(userAgent)) deviceBrand = 'Lenovo';
            
            fraudResults.deviceType = deviceType;
            fraudResults.deviceBrand = deviceBrand;
            fraudResults.deviceOS = deviceOS;
            fraudResults.browser = browser;
            fraudResults.screenResolution = `${screen.width}x${screen.height}`;
            fraudResults.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            fraudResults.language = navigator.language;
            
            return { deviceType, deviceBrand, deviceOS, browser };
        }

        // Advanced device consistency check (FIXED for Android)
        function checkDeviceConsistency() {
            const userAgent = navigator.userAgent.toLowerCase();
            let consistencyScore = 100;
            let warnings = [];
            
            // Check if device type matches user agent
            const isMobile = /mobile|android|iphone|ipod|ipad|blackberry|iemobile|opera mini/i.test(userAgent);
            const isTablet = /tablet|ipad|playbook|silk/i.test(userAgent);
            const isDesktop = !isMobile && !isTablet;
            
            // Screen size consistency
            if (isMobile && screen.width > 768) {
                consistencyScore -= 20;
                warnings.push('Mobile user agent with large screen detected');
            }
            
            if (isDesktop && screen.width < 768) {
                consistencyScore -= 20;
                warnings.push('Desktop user agent with small screen detected');
            }
            
            // Platform consistency
            const platform = navigator.platform.toLowerCase();
            if (platform.includes('win') && userAgent.includes('mac')) {
                consistencyScore -= 30;
                warnings.push('Platform/OS mismatch detected');
            }
            
            // Browser features consistency
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (isDesktop && hasTouch) {
                // Many modern laptops have touch screens, so this is less suspicious now
                consistencyScore -= 5;
            }
            
            if (isMobile && !hasTouch) {
                consistencyScore -= 25;
                warnings.push('Mobile device without touch support detected');
            }
            
            // Fix for Android: Don't penalize for common Android patterns
            if (userAgent.includes('android')) {
                // Android devices often have Chrome as browser - this is normal
                if (userAgent.includes('chrome')) {
                    // This is expected, no penalty
                }
                
                // Many Android devices have high DPI screens
                if (screen.width * screen.height > 2000000) {
                    // This is normal for modern Android devices
                }
            }
            
            fraudResults.checks.deviceConsistency = { score: consistencyScore, warnings };
            return { score: consistencyScore, warnings };
        }

        // Get IP address
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error getting IP:', error);
                return null;
            }
        }

        // Get IP information with fallback APIs
        async function getIPInfo(ip) {
            if (!ip) return null;
            
            let ipInfo = null;
            
            // Try ipapi.is first
            try {
                const response = await fetch(`https://api.ipapi.is/?q=${ip}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.ip) {
                        ipInfo = {
                            ip: data.ip,
                            country: data.location?.country_code || 'Unknown',
                            countryName: data.location?.country || 'Unknown',
                            region: data.location?.region || 'Unknown',
                            city: data.location?.city || 'Unknown',
                            isp: data.connection?.isp || 'Unknown',
                            asn: data.connection?.asn || 'Unknown',
                            organization: data.connection?.organization || 'Unknown',
                            proxy: data.proxy || false,
                            vpn: data.vpn || false,
                            tor: data.tor || false
                        };
                    }
                }
            } catch (error) {
                console.log('Error with ipapi.is:', error);
            }
            
            // Fallback to ipapi.co
            if (!ipInfo) {
                try {
                    const response = await fetch(`https://ipapi.co/${ip}/json/`);
                    if (response.ok) {
                        const data = await response.json();
                        ipInfo = {
                            ip: data.ip,
                            country: data.country_code || 'Unknown',
                            countryName: data.country_name || 'Unknown',
                            region: data.region || 'Unknown',
                            city: data.city || 'Unknown',
                            isp: data.org || data.isp || 'Unknown',
                            asn: data.asn || 'Unknown',
                            organization: data.org || 'Unknown',
                            proxy: data.proxy || data.privacy?.proxy || false,
                            vpn: data.vpn || data.privacy?.vpn || false,
                            tor: data.tor || data.privacy?.tor || false
                        };
                    }
                } catch (error) {
                    console.log('Error with ipapi.co:', error);
                }
            }
            
            return ipInfo;
        }

        // Analyze IP for risks
        function analyzeIP(ipInfo) {
            if (!ipInfo) return { riskScore: 0, warnings: [] };
            
            let riskScore = 0;
            const warnings = [];
            const highRiskCountries = ['cze', 'aut', 'usa', 'che'];
            const hostingProviders = ['amazon', 'google', 'microsoft', 'digitalocean', 'linode', 'vultr', 'ovh', 'hetzner'];
            
            // Check for VPN/Proxy
            if (ipInfo.vpn || ipInfo.proxy) {
                riskScore += 40;
                warnings.push('VPN/Proxy detected');
                fraudResults.isVPN = true;
            }
            
            // Check for hosting providers
            const orgLower = (ipInfo.organization || '').toLowerCase();
            const ispLower = (ipInfo.isp || '').toLowerCase();
            
            const isHosting = hostingProviders.some(provider => 
                orgLower.includes(provider) || ispLower.includes(provider)
            );
            
            if (isHosting) {
                riskScore += 30;
                warnings.push('Data center/hosting IP detected');
                fraudResults.isHosting = true;
            }
            
            // Check for Tor
            if (ipInfo.tor) {
                riskScore += 50;
                warnings.push('Tor network detected');
                fraudResults.isTor = true;
            }
            
            // Check for high-risk countries
            if (highRiskCountries.includes(ipInfo.country)) {
                riskScore += 25;
                warnings.push('High-risk country detected');
            }
            
            fraudResults.ip = ipInfo.ip;
            fraudResults.country = ipInfo.country;
            fraudResults.countryName = ipInfo.countryName;
            fraudResults.region = ipInfo.region;
            fraudResults.city = ipInfo.city;
            fraudResults.isp = ipInfo.isp;
            fraudResults.asn = ipInfo.asn;
            fraudResults.organization = ipInfo.organization;
            fraudResults.riskScore += riskScore;
            fraudResults.warnings = fraudResults.warnings.concat(warnings);
            fraudResults.checks.ipAnalysis = { score: riskScore, warnings };
            
            return { riskScore, warnings };
        }

        // Behavioral analysis
        function performBehavioralAnalysis() {
            let behaviorScore = 0;
            const behaviorWarnings = [];
            
            // Track user interactions
            document.addEventListener('mousemove', () => {
                fraudResults.mouseMovements++;
            });
            
            document.addEventListener('click', () => {
                fraudResults.clickCount++;
            });
            
            document.addEventListener('scroll', () => {
                fraudResults.scrollEvents++;
            });
            
            document.addEventListener('keydown', () => {
                fraudResults.keyPresses++;
            });
            
            // Time-based analysis
            fraudResults.pageLoadTime = performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart;
            
            if (fraudResults.pageLoadTime < 100) {
                behaviorScore += 15;
                behaviorWarnings.push('Suspiciously fast page load');
            }
            
            // Check for headless browser indicators
            if (!navigator.pdfViewerEnabled) {
                behaviorScore += 10;
                behaviorWarnings.push('PDF viewer disabled (headless indicator)');
            }
            
            fraudResults.checks.behaviorAnalysis = { score: behaviorScore, warnings: behaviorWarnings };
            fraudResults.riskScore += behaviorScore;
            fraudResults.warnings = fraudResults.warnings.concat(behaviorWarnings);
            
            return { score: behaviorScore, warnings: behaviorWarnings };
        }

        // Bot detection (improved)
        function performBotDetection() {
            const userAgent = navigator.userAgent.toLowerCase();
            const botPatterns = [
                /bot/i, /crawl/i, /spider/i, /scraper/i, /python/i, 
                /curl/i, /wget/i, /phantom/i, /selenium/i, /headless/i,
                /facebookexternalhit/i, /Twitterbot/i, /LinkedInBot/i,
                /Googlebot/i, /Bingbot/i, /Slurp/i, /DuckDuckBot/i,
                /Baiduspider/i, /YandexBot/i, /Sogou/i, /Exabot/i,
                /facebot/i, /ia_archiver/i
            ];
            
            let botScore = 0;
            let botWarnings = [];
            
            // User agent analysis
            if (botPatterns.some(pattern => pattern.test(userAgent))) {
                botScore += 30;
                botWarnings.push('Suspicious user agent detected');
            }
            
            // Headless browser indicators
            if (navigator.webdriver) {
                botScore += 25;
                botWarnings.push('WebDriver detected (possible automation)');
            }
            
            if (!window.chrome && userAgent.includes('chrome')) {
                botScore += 20;
                botWarnings.push('Chrome without chrome object detected');
            }
            
            // Plugin inconsistency
            if (navigator.plugins.length === 0 && userAgent.includes('chrome')) {
                botScore += 15;
                botWarnings.push('No plugins detected in Chrome (suspicious)');
            }
            
            fraudResults.isBot = botScore > 30;
            fraudResults.checks.botDetection = { score: botScore, warnings: botWarnings };
            
            return { score: botScore, warnings: botWarnings, isBot: botScore > 30 };
        }

        // Main fraud detection function
        async function detectFraud() {
            simulateProgress();
            
            // Step 1: Device detection
            updateCheckStatus('checkDevice', 'risk', 'In Progress...');
            const deviceInfo = detectDevice();
            const deviceConsistency = checkDeviceConsistency();
            
            if (deviceConsistency.score >= 80) {
                updateCheckStatus('checkDevice', 'safe', 'Consistent');
                updateStatusCard('deviceCard', 'success', 'Clean');
            } else if (deviceConsistency.score >= 60) {
                updateCheckStatus('checkDevice', 'risk', 'Minor Issues');
                updateStatusCard('deviceCard', 'warning', 'Suspicious');
            } else {
                updateCheckStatus('checkDevice', 'danger', 'Inconsistent');
                updateStatusCard('deviceCard', 'danger', 'High Risk');
            }
            
            // Step 2: Get IP address
            updateCheckStatus('checkIp', 'risk', 'In Progress...');
            const ip = await getIPAddress();
            if (!ip) {
                updateCheckStatus('checkIp', 'danger', 'Failed');
                fraudResults.warnings.push('Failed to retrieve IP address');
            } else {
                updateCheckStatus('checkIp', 'safe', 'Completed');
            }
            
            // Step 3: Get IP info
            updateCheckStatus('checkVpn', 'risk', 'In Progress...');
            updateCheckStatus('checkDataCenter', 'risk', 'In Progress...');
            const ipInfo = await getIPInfo(ip);
            const ipAnalysis = analyzeIP(ipInfo);
            
            if (ipAnalysis.warnings.length > 0) {
                updateCheckStatus('checkVpn', ipAnalysis.warnings.some(w => w.includes('VPN') || w.includes('Proxy')) ? 'danger' : 'risk', 
                                ipAnalysis.warnings.some(w => w.includes('VPN') || w.includes('Proxy')) ? 'Detected' : 'Clean');
                updateCheckStatus('checkDataCenter', ipAnalysis.warnings.some(w => w.includes('Data center')) ? 'danger' : 'safe', 
                                ipAnalysis.warnings.some(w => w.includes('Data center')) ? 'Detected' : 'Clean');
                
                if (ipAnalysis.warnings.some(w => w.includes('VPN') || w.includes('Proxy') || w.includes('Data center'))) {
                    updateStatusCard('ipCard', 'danger', 'High Risk');
                } else {
                    updateStatusCard('ipCard', 'warning', 'Suspicious');
                }
            } else {
                updateCheckStatus('checkVpn', 'safe', 'Clean');
                updateCheckStatus('checkDataCenter', 'safe', 'Clean');
                updateStatusCard('ipCard', 'success', 'Good');
            }
            
            // Step 4: Bot detection
            updateCheckStatus('checkBrowser', 'risk', 'In Progress...');
            const botDetection = performBotDetection();
            
            if (botDetection.isBot) {
                updateCheckStatus('checkBrowser', 'danger', 'Bot Detected');
                updateStatusCard('behaviorCard', 'danger', 'Automated');
            } else if (botDetection.score > 10) {
                updateCheckStatus('checkBrowser', 'risk', 'Suspicious');
                updateStatusCard('behaviorCard', 'warning', 'Suspicious');
            } else {
                updateCheckStatus('checkBrowser', 'safe', 'Valid');
                updateStatusCard('behaviorCard', 'success', 'Normal');
            }
            
            // Step 5: Behavioral analysis
            updateCheckStatus('checkBehavior', 'risk', 'In Progress...');
            updateCheckStatus('clickPattern', 'risk', 'In Progress...');
            setTimeout(() => {
                const behaviorAnalysis = performBehavioralAnalysis();
                
                if (behaviorAnalysis.score > 10) {
                    updateCheckStatus('checkBehavior', 'risk', 'Anomalies');
                    updateCheckStatus('clickPattern', 'risk', 'Suspicious');
                } else {
                    updateCheckStatus('checkBehavior', 'safe', 'Normal');
                    updateCheckStatus('clickPattern', 'safe', 'Normal');
                }
            }, 2000);
            
            // Step 6: Geolocation analysis
            updateCheckStatus('checkGeo', 'risk', 'In Progress...');
            setTimeout(() => {
                if (ipInfo) {
                    const highRiskCountries = ['cze', 'aut', 'usa', 'che'];
                    updateCheckStatus('checkGeo', highRiskCountries.includes(ipInfo.country) ? 'risk' : 'safe', 
                                    highRiskCountries.includes(ipInfo.country) ? 'High Risk' : 'Normal');
                    
                    updateStatusCard('geoCard', highRiskCountries.includes(ipInfo.country) ? 'warning' : 'success', 
                                   highRiskCountries.includes(ipInfo.country) ? 'High Risk' : 'Low Risk');
                } else {
                    updateCheckStatus('checkGeo', 'danger', 'Failed');
                    updateStatusCard('geoCard', 'danger', 'Error');
                }
                
                // Finalize results
                finalizeResults();
            }, 3000);
            
            return fraudResults;
        }

        // Finalize and display results
        function finalizeResults() {
            updateProgress(100);
            
            // Calculate final risk score (0-100)
            const finalRiskScore = Math.min(100, fraudResults.riskScore);
            
            // Update risk score display
            document.getElementById('riskScoreValue').textContent = finalRiskScore;
            document.getElementById('riskFill').style.width = finalRiskScore + '%';
            document.getElementById('riskMarker').style.left = finalRiskScore + '%';
            
            // Determine risk category
            let riskCategory = 'Low Risk';
            if (finalRiskScore >= 70) riskCategory = 'High Risk';
            else if (finalRiskScore >= 30) riskCategory = 'Medium Risk';
            
            document.getElementById('riskCategory').textContent = riskCategory;
            
            // Show final result
            const finalResult = document.getElementById('finalResult');
            if (finalRiskScore < 30) {
                finalResult.className = 'final-result result-safe';
                document.getElementById('resultIcon').textContent = '✅';
                document.getElementById('resultTitle').textContent = 'Connection Verified';
                document.getElementById('resultDesc').textContent = 'Your connection appears to be secure with low risk indicators. This traffic is likely suitable for CPA offers.';
            } else if (finalRiskScore < 70) {
                finalResult.className = 'final-result result-warning';
                document.getElementById('resultIcon').textContent = '⚠️';
                document.getElementById('resultTitle').textContent = 'Suspicious Activity Detected';
                document.getElementById('resultDesc').textContent = 'We detected some suspicious indicators. This traffic may have higher fraud potential for CPA offers.';
            } else {
                finalResult.className = 'final-result result-danger';
                document.getElementById('resultIcon').textContent = '🚫';
                document.getElementById('resultTitle').textContent = 'High Risk Connection';
                document.getElementById('resultDesc').textContent = 'Your connection shows multiple high-risk indicators. This traffic is likely fraudulent for CPA offers.';
            }
            
            // Populate device info
            const deviceInfo = document.getElementById('deviceInfo');
            deviceInfo.innerHTML = `
                <div class="device-tag">${fraudResults.deviceType}</div>
                <div class="device-tag">${fraudResults.deviceOS}</div>
                <div class="device-tag">${fraudResults.browser}</div>
                <div class="device-tag">${fraudResults.screenResolution}</div>
                <div class="device-tag">${fraudResults.country}</div>
            `;
            
            // Show results section
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            // Update timestamp
            updateTimestamp('resultTimestamp');
        }

        // Toggle details panel
        document.getElementById('toggleDetails').addEventListener('click', function() {
            const content = document.getElementById('detailsContent');
            const icon = this.querySelector('.toggle-icon');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.classList.remove('rotated');
            } else {
                content.classList.add('show');
                icon.classList.add('rotated');
            }
        });

        // Toggle tracking data
        function toggleTrackingData() {
            const trackingData = document.getElementById('trackingData');
            const trackingText = document.getElementById('trackingData');
            
            if (trackingData.style.display === 'none' || trackingData.style.display === '') {
                // Generate CPA network-style tracking data
                trackingText.textContent = JSON.stringify({
                    click_id: fraudResults.clickId,
                    session_id: fraudResults.sessionId,
                    timestamp: fraudResults.timestamp,
                    ip: fraudResults.ip,
                    country: fraudResults.country,
                    device: {
                        type: fraudResults.deviceType,
                        os: fraudResults.deviceOS,
                        browser: fraudResults.browser,
                        resolution: fraudResults.screenResolution
                    },
                    risk_score: fraudResults.riskScore,
                    warnings: fraudResults.warnings,
                    referrer: fraudResults.referrer,
                    user_agent: navigator.userAgent
                }, null, 2);
                
                trackingData.style.display = 'block';
            } else {
                trackingData.style.display = 'none';
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                detectFraud().catch(error => {
                    console.error('Fraud detection error:', error);
                    updateCheckStatus('checkIp', 'danger', 'Error');
                    updateCheckStatus('checkVpn', 'danger', 'Error');
                    finalizeResults();
                });
            }, 1000);
        });
    </script>
</body>
</html>
